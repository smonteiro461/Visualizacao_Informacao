<<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padrões Emergentes: Habitação e Exclusão</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://db.onlinewebfonts.com/c/980f41a37f1c14ff5c0aefec5c2239e3?family=Tableau+Book+Regular" rel="stylesheet">
    <script src="https://unpkg.com/topojson@3"></script>
    <style>
        /* --- ESTILOS GERAIS --- */
        :root { --blue: #1F77B4; --orange: #FF7F0E; --grey: #94a3b8; --bg: #f8f9fa; --text: #333; }
        body { font-family: 'Tableau Book Regular', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; min-height: 100vh;}
        header { text-align: center; margin-bottom: 40px; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 10px 12px rgba(0,0,0,0.05); }
        h1 { margin: 0 0 10px 0; color: #2c3e50; letter-spacing: -0.5px; }
        .intro { color: #666; max-width: 1400px; margin: 0 auto; line-height: 1.5; }
        
        /* GRID LAYOUT - 4 LINHAS DEFINIDAS */
        .dashboard-grid { 
            display: grid; 
            grid-template-columns: repeat(12, 1fr); 
            gap: 30px; 
            max-width: 1400px; 
            margin: 0 auto; 
            flex: 1; 
        }
        
        /* Linha 1: Contexto (1.1 e 1.2) */
        .row-1-left { grid-column: span 6; }
        .row-1-right { grid-column: span 6; }
        
        /* Linha 2: Desigualdade (1.3) */
        .row-2-full { grid-column: span 12; }
        
        /* Linha 3: Habitação e Mapa (2.1 e 2.2) */
        .row-3-left { grid-column: span 6; }
        .row-3-right { grid-column: span 6; }
        
        /* Linha 4: Scatter (3) */
        .row-4-full { grid-column: span 12; }

        .viz-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); display: flex; flex-direction: column; transition: transform 0.2s ease; }
        
        /* ESTILO DOS TÍTULOS */
        h3 { margin-top: 0; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .viz-cat { display: block; font-size: 10px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; margin-bottom: 4px; }
        .viz-title { display: block; font-size: 16px; color: #2c3e50; font-weight: 600; }
        .narrative { background: #f8fafc; border-left: 4px solid var(--blue); padding: 12px 15px; margin-top: auto; font-size: 0.85em; color: #475569; line-height: 1.4; }
        
        /* INTERATIVIDADE */
        .dimmed { opacity: 0.1 !important; transition: opacity 0.2s; }
        .highlighted { opacity: 1 !important; stroke: #2c3e50 !important; }
        circle.highlighted, rect.highlighted, path.highlighted { fill: var(--orange) !important; }
        line.highlighted { stroke: var(--orange) !important; stroke-width: 3px !important; }
        path.line-highlighted { stroke: var(--orange) !important; stroke-width: 3px !important; opacity: 1 !important; }
        .map-circle { stroke: white; stroke-width: 1px; cursor: pointer; transition: all 0.4s ease; }
        .map-circle:hover { stroke: #333; stroke-width: 2px; }
        .map-label { font-size: 10px; fill: white; pointer-events: none; font-weight: bold; text-shadow: 0px 0px 4px rgba(255,255,255,0.8); }
        #tooltip { position: absolute; opacity: 0; background: rgba(255,255,255,0.98); border: 1px solid #e2e8f0; padding: 12px; border-radius: 6px; pointer-events: none; font-size: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); z-index: 1000; color: #1e293b; }
        
        .controls { display: flex; gap: 8px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
        button { padding: 6px 12px; border: 1px solid #e2e8f0; background: white; cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: 600; color: #64748b; transition: all 0.2s; }
        button:hover { background: #f1f5f9; color: #333; }
        button.active { background: var(--blue); color: white; border-color: var(--blue); }
        .metric-btn.active { background: #334155; border-color: #334155; }
        .axis text { fill: #94a3b8; font-size: 10px; }
        .domain, .tick line { stroke: #e2e8f0; }
        .legend-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 4px; }
        .legend-bar { width: 8px; height: 8px; background: #ccc; display: inline-block; margin-right: 4px; }
        .grid-break { grid-column: 1 / -1; height: 0; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: var(--blue); }

        footer { margin-top: 60px; padding: 30px 0; background-color: white; border-top: 1px solid #e2e8f0; color: #64748b; font-size: 0.75rem; line-height: 1.6; }
        .footer-content { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 30px; }
        .footer-section h4 { font-size: 0.85rem; color: #334155; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 0.5px; }
   </style>
</head>
<body>

    <header>
        <h1>Padrões Emergentes entre a Crise Habitacional <br> e a População Sem-Abrigo em Portugal</h1>
        <p class="intro">
            De que forma o custo de vida e as rendas altas explicam a evolução dos sem-abrigo?
            Segundo dados recentes, a convergência entre o aumento abrupto dos custos imobiliários e a perda de poder de compra gerou um novo perfil de vulnerabilidade, contribuindo diretamente para o aumento da população sem-abrigo (Observador, 2024).
            Fizemos uma análise multidimensional que cruza dados macroeconómicos, imobiliários e demográficos (2018–2023).
            <br>
            <em style="font-size:0.7em; color:var(--blue)">Interaja com os gráficos para destacar distritos transversalmente.</em>
        </p>
    </header>

    <div class="dashboard-grid">
        <div class="viz-card row-1-left">
            <h3><span class="viz-cat">1.1 Contexto Económico</span><span class="viz-title">Tendências Demográficas e Socioeconómicas</span></h3>
            <div id="viz1-1"></div>
            <div class="narrative"><strong>O Desafio Estrutural:</strong> O envelhecimento da população e o aumento do risco de pobreza (linhas superiores) convergem, criando uma base demográfica vulnerável.</div>
        </div>

        <div class="viz-card row-1-right">
            <h3><span class="viz-cat">1.2 Contexto Económico</span><span class="viz-title">Correlação: Poder de Compra e Inflação</span></h3>
            <div style="font-size: 10px; margin-bottom: 5px; display: flex; justify-content: center; gap: 10px;">
                <span><span class="legend-bar" style="width:8px;height:8px;background:#ccc;display:inline-block"></span>Inflação</span>
                <span><span class="legend-dot" style="background:#1F77B4;width:8px;height:8px;border-radius:50%;display:inline-block"></span>Poder Compra</span>
                <span><span class="legend-dot" style="background:#FF7F0E;width:8px;height:8px;border-radius:50%;display:inline-block"></span>Sem-Abrigo</span>
            </div>
            <div id="viz1-2"></div>
            <div class="narrative"><strong>O Ponto de Rutura (2022):</strong> O pico da inflação erodiu os ganhos no poder de compra, coincidindo com a duplicação abrupta da população sem-abrigo.</div>
        </div>

        <div class="viz-card row-2-full">
            <h3><span class="viz-cat">1.3 Contexto Económico</span><span class="viz-title">Desigualdade do Rendimento Bruto (S80/S20)</span></h3>
            <div class="controls" style="margin-bottom:10px;">
                <button id="btn-ineq-val" class="active" onclick="setSortInequality('value')">Maior Desigualdade</button>
                <button id="btn-ineq-abc" onclick="setSortInequality('name')">A-Z</button>
            </div>
            <div id="viz1-3" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px;"></div>
            <div class="narrative"><strong>Assimetria Persistente:</strong> As metrópoles (Lisboa e Porto) perpetuam um fosso profundo entre ricos e pobres (>12).</div>
        </div>

        <div class="viz-card row-3-left">
            <h3><span class="viz-cat">2.1 Habitação</span><span class="viz-title">Valores Compra e Renda por m² (€)</span></h3>
            <div class="controls">
                <button class="metric-btn active" onclick="setMetric('renda')">Arrendamento (€/m²)</button>
                <button class="metric-btn" onclick="setMetric('compra')">Compra (€/m²)</button>
                <span style="margin:0 5px; color:#ddd">|</span>
                <button id="btn-val" class="active" onclick="setSort('value')">Maior Aumento</button>
                <button id="btn-abc" onclick="setSort('name')">A-Z</button>
            </div>
            <div id="viz2-1"></div>
            <div class="narrative" id="dumbbell-narrative"></div>
        </div>

        <div class="viz-card row-3-right" style="position:relative;">
            <h3><span class="viz-cat">2.2 Consequência</span><span class="viz-title">Número de Sem Abrigos em Portugal</span></h3>
            <div style="padding: 5px 20px; background:#f1f5f9; border-radius:6px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <label for="yearSlider" style="font-size:11px; font-weight:bold; color:#555; text-transform:uppercase;">Filtrar Ano</label>
                    <span id="yearDisplay" style="color:var(--blue); font-weight:bold; font-size:16px;">2023</span>
                </div>
                <input type="range" id="yearSlider" min="2018" max="2023" value="2023" step="1" oninput="updateMapYear(this.value)">
                <div style="display:flex; justify-content:space-between; font-size:10px; color:#999;">
                    <span>2018</span><span>2023</span>
                </div>
            </div>
            <div id="viz-map" style="display: flex; justify-content: center; height: 350px;"></div>
            <div class="narrative" id="map-narrative"><strong>Uma Crise Invisível:</strong> A intensidade relativa (cor laranja) revela crises agudas no interior.</div>
        </div>

        <div class="viz-card row-4-full">
            <h3><span class="viz-cat">3. Síntese</span><span class="viz-title">Relação entre Pressão Imobiliária e Exclusão Social</span></h3>
            <div id="viz-scatter"></div>
            <div class="narrative"><strong>Duas Realidades Distintas:</strong> À direita, exclusão por mercado inacessível. No topo esquerdo, "outliers" como Beja.</div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-section">
                <h4>Âmbito do Estudo</h4>
                <p><strong>Janela Temporal:</strong> 2018–2023.<br><strong>Granularidade:</strong> Análise por Distrito.</p>
            </div>
            <div class="footer-section">
                <h4>Dados e Metodologia</h4>
                <p><strong>Fontes:</strong> INE, PORDATA, Idealista e ENIPSSA.</p>
            </div>
            <div class="footer-section">
                <h4>Ficha Técnica</h4>
                <p><strong>Autoria:</strong> Sophia Pamella Rufina Ribeiro, Sofia Margarida de Sousa Monteiro e José Daniel Sottolano Velar.<br><strong>Última Atualização:</strong> Fevereiro 2026.</p>
            </div>
        </div>
    </footer>

    <div id="tooltip"></div>

    <script>
        const fnum = d => d3.format(",.0f")(d).replace(/,/g, ".");

        const distritos = [
            {'id': 'aveiro', 'nome': 'Aveiro', 'regiao': 'Centro', 'renda18': 3.89, 'renda23': 5.77, 'compra18': 994.0, 'compra23': 1668.0, 'semabrigo': 1.24, 'populacao': 720038, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 54, 'populacao': 698457, 'taxa': 0.77}, 2019: {'semabrigo': 75, 'populacao': 700087, 'taxa': 1.07}, 2020: {'semabrigo': 57, 'populacao': 702802, 'taxa': 0.81}, 2021: {'semabrigo': 54, 'populacao': 706448, 'taxa': 0.76}, 2022: {'semabrigo': 68, 'populacao': 711758, 'taxa': 0.96}, 2023: {'semabrigo': 89, 'populacao': 720038, 'taxa': 1.24}}}, 
            {'id': 'beja', 'nome': 'Beja', 'regiao': 'Alentejo', 'renda18': 4.09, 'renda23': 5.69, 'compra18': 793.0, 'compra23': 1054.0, 'semabrigo': 40.29, 'populacao': 148163, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 24, 'populacao': 144465, 'taxa': 1.66}, 2019: {'semabrigo': 54, 'populacao': 144516, 'taxa': 3.74}, 2020: {'semabrigo': 324, 'populacao': 145119, 'taxa': 22.33}, 2021: {'semabrigo': 256, 'populacao': 145866, 'taxa': 17.55}, 2022: {'semabrigo': 663, 'populacao': 146899, 'taxa': 45.13}, 2023: {'semabrigo': 597, 'populacao': 148163, 'taxa': 40.29}}}, 
            {'id': 'braga', 'nome': 'Braga', 'regiao': 'Norte', 'renda18': 4.35, 'renda23': 6.98, 'compra18': 911.0, 'compra23': 1501.0, 'semabrigo': 1.49, 'populacao': 859818, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 102, 'populacao': 838637, 'taxa': 1.22}, 2019: {'semabrigo': 148, 'populacao': 842266, 'taxa': 1.76}, 2020: {'semabrigo': 80, 'populacao': 847164, 'taxa': 0.94}, 2021: {'semabrigo': 115, 'populacao': 849837, 'taxa': 1.35}, 2022: {'semabrigo': 161, 'populacao': 853108, 'taxa': 1.89}, 2023: {'semabrigo': 128, 'populacao': 859818, 'taxa': 1.49}}}, 
            {'id': 'braganca', 'nome': 'Bragança', 'regiao': 'Norte', 'renda18': 2.49, 'renda23': 3.19, 'compra18': 688.0, 'compra23': 872.0, 'semabrigo': 2.37, 'populacao': 122556, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 19, 'populacao': 125729, 'taxa': 1.51}, 2019: {'semabrigo': 17, 'populacao': 124933, 'taxa': 1.36}, 2020: {'semabrigo': 14, 'populacao': 124047, 'taxa': 1.13}, 2021: {'semabrigo': 15, 'populacao': 122964, 'taxa': 1.22}, 2022: {'semabrigo': 26, 'populacao': 122412, 'taxa': 2.12}, 2023: {'semabrigo': 29, 'populacao': 122556, 'taxa': 2.37}}}, 
            {'id': 'castelobranco', 'nome': 'Castelo Branco', 'regiao': 'Centro', 'renda18': 3.14, 'renda23': 4.0, 'compra18': 668.0, 'compra23': 867.0, 'semabrigo': 0.0, 'populacao': 178934, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 0, 'populacao': 180772, 'taxa': 0.0}, 2019: {'semabrigo': 0, 'populacao': 179570, 'taxa': 0.0}, 2020: {'semabrigo': 0, 'populacao': 179016, 'taxa': 0.0}, 2021: {'semabrigo': 0, 'populacao': 178767, 'taxa': 0.0}, 2022: {'semabrigo': 0, 'populacao': 178462, 'taxa': 0.0}, 2023: {'semabrigo': 0, 'populacao': 178934, 'taxa': 0.0}}}, 
            {'id': 'coimbra', 'nome': 'Coimbra', 'regiao': 'Centro', 'renda18': 4.17, 'renda23': 5.62, 'compra18': 996.0, 'compra23': 1391.0, 'semabrigo': 6.55, 'populacao': 415507, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 200, 'populacao': 412047, 'taxa': 4.85}, 2019: {'semabrigo': 433, 'populacao': 411215, 'taxa': 10.53}, 2020: {'semabrigo': 126, 'populacao': 411067, 'taxa': 3.07}, 2021: {'semabrigo': 154, 'populacao': 411170, 'taxa': 3.75}, 2022: {'semabrigo': 242, 'populacao': 412194, 'taxa': 5.87}, 2023: {'semabrigo': 272, 'populacao': 415507, 'taxa': 6.55}}}, 
            {'id': 'evora', 'nome': 'Évora', 'regiao': 'Alentejo', 'renda18': 5.31, 'renda23': 6.83, 'compra18': 847.0, 'compra23': 1322.0, 'semabrigo': 8.81, 'populacao': 153315, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 21, 'populacao': 155312, 'taxa': 1.35}, 2019: {'semabrigo': 33, 'populacao': 154272, 'taxa': 2.14}, 2020: {'semabrigo': 25, 'populacao': 153636, 'taxa': 1.63}, 2021: {'semabrigo': 159, 'populacao': 153452, 'taxa': 10.36}, 2022: {'semabrigo': 99, 'populacao': 153331, 'taxa': 6.46}, 2023: {'semabrigo': 135, 'populacao': 153315, 'taxa': 8.81}}}, 
            {'id': 'faro', 'nome': 'Faro', 'regiao': 'Algarve', 'renda18': 5.52, 'renda23': 7.25, 'compra18': 2032.0, 'compra23': 3251.0, 'semabrigo': 2.64, 'populacao': 481370, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 61, 'populacao': 457855, 'taxa': 1.33}, 2019: {'semabrigo': 34, 'populacao': 462603, 'taxa': 0.73}, 2020: {'semabrigo': 113, 'populacao': 467751, 'taxa': 2.42}, 2021: {'semabrigo': 151, 'populacao': 469937, 'taxa': 3.21}, 2022: {'semabrigo': 0, 'populacao': 474300, 'taxa': 0.0}, 2023: {'semabrigo': 127, 'populacao': 481370, 'taxa': 2.64}}}, 
            {'id': 'guarda', 'nome': 'Guarda', 'regiao': 'Centro', 'renda18': 2.9, 'renda23': 4.01, 'compra18': 656.0, 'compra23': 704.0, 'semabrigo': 0.0, 'populacao': 141810, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 0, 'populacao': 146877, 'taxa': 0.0}, 2019: {'semabrigo': 0, 'populacao': 145285, 'taxa': 0.0}, 2020: {'semabrigo': 0, 'populacao': 144308, 'taxa': 0.0}, 2021: {'semabrigo': 0, 'populacao': 143416, 'taxa': 0.0}, 2022: {'semabrigo': 0, 'populacao': 142247, 'taxa': 0.0}, 2023: {'semabrigo': 0, 'populacao': 141810, 'taxa': 0.0}}}, 
            {'id': 'leiria', 'nome': 'Leiria', 'regiao': 'Centro', 'renda18': 3.8, 'renda23': 5.3, 'compra18': 1054.0, 'compra23': 1557.0, 'semabrigo': 0.93, 'populacao': 474675, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 31, 'populacao': 456022, 'taxa': 0.68}, 2019: {'semabrigo': 16, 'populacao': 456227, 'taxa': 0.35}, 2020: {'semabrigo': 18, 'populacao': 459071, 'taxa': 0.39}, 2021: {'semabrigo': 64, 'populacao': 463126, 'taxa': 1.38}, 2022: {'semabrigo': 78, 'populacao': 467629, 'taxa': 1.67}, 2023: {'semabrigo': 44, 'populacao': 474675, 'taxa': 0.93}}}, 
            {'id': 'lisboa', 'nome': 'Lisboa', 'regiao': 'AML', 'renda18': 7.0, 'renda23': 11.05, 'compra18': 2919.0, 'compra23': 3896.0, 'semabrigo': 14.44, 'populacao': 2338553, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 2473, 'populacao': 2268558, 'taxa': 10.9}, 2019: {'semabrigo': 3145, 'populacao': 2282310, 'taxa': 13.78}, 2020: {'semabrigo': 3780, 'populacao': 2289222, 'taxa': 16.51}, 2021: {'semabrigo': 3328, 'populacao': 2287054, 'taxa': 14.55}, 2022: {'semabrigo': 3138, 'populacao': 2304554, 'taxa': 13.62}, 2023: {'semabrigo': 3378, 'populacao': 2338553, 'taxa': 14.44}}}, 
            {'id': 'portalegre', 'nome': 'Portalegre', 'regiao': 'Alentejo', 'renda18': 2.79, 'renda23': 3.51, 'compra18': 788.0, 'compra23': 721.0, 'semabrigo': 1.73, 'populacao': 104192, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 19, 'populacao': 107954, 'taxa': 1.76}, 2019: {'semabrigo': 18, 'populacao': 106776, 'taxa': 1.69}, 2020: {'semabrigo': 20, 'populacao': 105950, 'taxa': 1.89}, 2021: {'semabrigo': 21, 'populacao': 105353, 'taxa': 1.99}, 2022: {'semabrigo': 18, 'populacao': 104667, 'taxa': 1.72}, 2023: {'semabrigo': 18, 'populacao': 104192, 'taxa': 1.73}}}, 
            {'id': 'porto', 'nome': 'Porto', 'regiao': 'Norte', 'renda18': 5.07, 'renda23': 7.98, 'compra18': 1632.0, 'compra23': 2516.0, 'semabrigo': 3.25, 'populacao': 1835685, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 560, 'populacao': 1788529, 'taxa': 3.13}, 2019: {'semabrigo': 592, 'populacao': 1792174, 'taxa': 3.3}, 2020: {'semabrigo': 590, 'populacao': 1793813, 'taxa': 3.29}, 2021: {'semabrigo': 730, 'populacao': 1797927, 'taxa': 4.06}, 2022: {'semabrigo': 647, 'populacao': 1814207, 'taxa': 3.57}, 2023: {'semabrigo': 597, 'populacao': 1835685, 'taxa': 3.25}}}, 
            {'id': 'santarem', 'nome': 'Santarém', 'regiao': 'Alentejo', 'renda18': 3.48, 'renda23': 5.63, 'compra18': 770.0, 'compra23': 1126.0, 'semabrigo': 1.05, 'populacao': 438377, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 23, 'populacao': 426873, 'taxa': 0.54}, 2019: {'semabrigo': 21, 'populacao': 425054, 'taxa': 0.49}, 2020: {'semabrigo': 36, 'populacao': 426110, 'taxa': 0.84}, 2021: {'semabrigo': 26, 'populacao': 429567, 'taxa': 0.61}, 2022: {'semabrigo': 38, 'populacao': 433566, 'taxa': 0.88}, 2023: {'semabrigo': 46, 'populacao': 438377, 'taxa': 1.05}}}, 
            {'id': 'setubal', 'nome': 'Setúbal', 'regiao': 'AML', 'renda18': 5.14, 'renda23': 8.95, 'compra18': 1320.0, 'compra23': 2444.0, 'semabrigo': 1.15, 'populacao': 897257, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 161, 'populacao': 861549, 'taxa': 1.87}, 2019: {'semabrigo': 0, 'populacao': 866508, 'taxa': 0.0}, 2020: {'semabrigo': 166, 'populacao': 875174, 'taxa': 1.9}, 2021: {'semabrigo': 155, 'populacao': 881403, 'taxa': 1.76}, 2022: {'semabrigo': 94, 'populacao': 887120, 'taxa': 1.06}, 2023: {'semabrigo': 103, 'populacao': 897257, 'taxa': 1.15}}}, 
            {'id': 'vianadocastelo', 'nome': 'Viana do Castelo', 'regiao': 'Norte', 'renda18': 4.0, 'renda23': 6.31, 'compra18': 999.0, 'compra23': 1457.0, 'semabrigo': 1.63, 'populacao': 233444, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 56, 'populacao': 232401, 'taxa': 2.41}, 2019: {'semabrigo': 41, 'populacao': 232004, 'taxa': 1.77}, 2020: {'semabrigo': 36, 'populacao': 232234, 'taxa': 1.55}, 2021: {'semabrigo': 30, 'populacao': 232163, 'taxa': 1.29}, 2022: {'semabrigo': 32, 'populacao': 232278, 'taxa': 1.38}, 2023: {'semabrigo': 38, 'populacao': 233444, 'taxa': 1.63}}}, 
            {'id': 'vilareal', 'nome': 'Vila Real', 'regiao': 'Norte', 'renda18': 3.53, 'renda23': 4.68, 'compra18': 749.0, 'compra23': 942.0, 'semabrigo': 1.41, 'populacao': 184892, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 5, 'populacao': 189417, 'taxa': 0.26}, 2019: {'semabrigo': 5, 'populacao': 187908, 'taxa': 0.27}, 2020: {'semabrigo': 0, 'populacao': 186861, 'taxa': 0.0}, 2021: {'semabrigo': 0, 'populacao': 185808, 'taxa': 0.0}, 2022: {'semabrigo': 46, 'populacao': 184923, 'taxa': 2.49}, 2023: {'semabrigo': 26, 'populacao': 184892, 'taxa': 1.41}}}, 
            {'id': 'viseu', 'nome': 'Viseu', 'regiao': 'Centro', 'renda18': 3.65, 'renda23': 5.33, 'compra18': 735.0, 'compra23': 1066.0, 'semabrigo': 0.2, 'populacao': 353663, 's80s20': 8.0, 'historico': {2018: {'semabrigo': 0, 'populacao': 354039, 'taxa': 0.0}, 2019: {'semabrigo': 0, 'populacao': 352707, 'taxa': 0.0}, 2020: {'semabrigo': 0, 'populacao': 352827, 'taxa': 0.0}, 2021: {'semabrigo': 0, 'populacao': 352943, 'taxa': 0.0}, 2022: {'semabrigo': 4, 'populacao': 352368, 'taxa': 0.11}, 2023: {'semabrigo': 7, 'populacao': 353663, 'taxa': 0.2}}}
        ];

        const data11 = [
            {year: '2018', populacaoTotal: 10334633, intensidadePobreza: 2314958, pop65: 2273940, riscoPobreza: 2222100, desemprego: 713090},
            {year: '2019', populacaoTotal: 10354446, intensidadePobreza: 2526485, pop65: 2327150, riscoPobreza: 2173000, desemprego: 735166},
            {year: '2020', populacaoTotal: 10384846, intensidadePobreza: 2814293, pop65: 2385368, riscoPobreza: 2056200, desemprego: 737324},
            {year: '2021', populacaoTotal: 10407707, intensidadePobreza: 2258472, pop65: 2436949, riscoPobreza: 2311500, desemprego: 645278},
            {year: '2022', populacaoTotal: 10468869, intensidadePobreza: 2680030, pop65: 2486274, riscoPobreza: 2083600, desemprego: 732821},
            {year: '2023', populacaoTotal: 10578174, intensidadePobreza: 2718591, pop65: 2537740, riscoPobreza: 2103600, desemprego: 708738}
        ];

        const data1_2 = [
            {year: 2018, poder: 205184, semabrigo: 12088, inflacao: 0.99},
            {year: 2019, poder: 214374, semabrigo: 14214, inflacao: 0.34},
            {year: 2020, poder: 200518, semabrigo: 16418, inflacao: -0.01},
            {year: 2021, poder: 216493, semabrigo: 19208, inflacao: 1.27},
            {year: 2022, poder: 243957, semabrigo: 21546, inflacao: 7.83},
            {year: 2023, poder: 267384, semabrigo: 26256, inflacao: 4.31}
        ];

        const inequalityData = [
            { distrito: "Viana do Castelo", values: [{year:2018,value:7.9},{year:2019,value:7.8},{year:2020,value:7.7},{year:2021,value:7.7},{year:2022,value:7.7},{year:2023,value:7.8}]},
            { distrito: "Braga", values: [{year:2018,value:8.3},{year:2019,value:8.1},{year:2020,value:8.5},{year:2021,value:8.4},{year:2022,value:8.6},{year:2023,value:8.6}]},
            { distrito: "Porto", values: [{year:2018,value:12.6},{year:2019,value:12.1},{year:2020,value:12.8},{year:2021,value:12.8},{year:2022,value:13.0},{year:2023,value:13.1}]},
            { distrito: "Vila Real", values: [{year:2018,value:9.9},{year:2019,value:9.2},{year:2020,value:9.5},{year:2021,value:8.9},{year:2022,value:9.0},{year:2023,value:9.2}]},
            { distrito: "Bragança", values: [{year:2018,value:8.8},{year:2019,value:9.2},{year:2020,value:9.2},{year:2021,value:9.3},{year:2022,value:9.0},{year:2023,value:9.1}]},
            { distrito: "Aveiro", values: [{year:2018,value:8.8},{year:2019,value:8.7},{year:2020,value:8.9},{year:2021,value:8.5},{year:2022,value:8.8},{year:2023,value:8.9}]},
            { distrito: "Coimbra", values: [{year:2018,value:9.3},{year:2019,value:9.1},{year:2020,value:9.2},{year:2021,value:9.2},{year:2022,value:9.3},{year:2023,value:9.4}]},
            { distrito: "Leiria", values: [{year:2018,value:7.2},{year:2019,value:7.2},{year:2020,value:7.1},{year:2021,value:7.0},{year:2022,value:7.1},{year:2023,value:7.3}]},
            { distrito: "Viseu", values: [{year:2018,value:8.2},{year:2019,value:8.1},{year:2020,value:8.3},{year:2021,value:8.1},{year:2022,value:8.1},{year:2023,value:8.2}]},
            { distrito: "Castelo Branco", values: [{year:2018,value:7.1},{year:2019,value:7.0},{year:2020,value:7.0},{year:2021,value:6.9},{year:2022,value:7.1},{year:2023,value:7.1}]},
            { distrito: "Guarda", values: [{year:2018,value:7.6},{year:2019,value:7.5},{year:2020,value:7.6},{year:2021,value:7.6},{year:2022,value:7.4},{year:2023,value:7.3}]},
            { distrito: "Santarém", values: [{year:2018,value:7.6},{year:2019,value:7.5},{year:2020,value:7.8},{year:2021,value:7.4},{year:2022,value:7.8},{year:2023,value:8.6}]},
            { distrito: "Lisboa", values: [{year:2018,value:11.8},{year:2019,value:11.55},{year:2020,value:12.5},{year:2021,value:12.35},{year:2022,value:12.5},{year:2023,value:12.7}]},
            { distrito: "Beja", values: [{year:2018,value:7.7},{year:2019,value:7.8},{year:2020,value:7.8},{year:2021,value:7.7},{year:2022,value:8.2},{year:2023,value:9.1}]},
            { distrito: "Portalegre", values: [{year:2018,value:6.8},{year:2019,value:6.8},{year:2020,value:7.0},{year:2021,value:6.8},{year:2022,value:6.9},{year:2023,value:6.9}]},
            { distrito: "Évora", values: [{year:2018,value:7.3},{year:2019,value:7.1},{year:2020,value:7.4},{year:2021,value:7.2},{year:2022,value:7.2},{year:2023,value:7.2}]},
            { distrito: "Faro", values: [{year:2018,value:9.4},{year:2019,value:9.3},{year:2020,value:10.6},{year:2021,value:10.1},{year:2022,value:9.9},{year:2023,value:9.8}]}
        ];

        let selectedDistrito = null; 
        let currentMetric = 'renda';
        let currentSort = 'value';
        let currentSort1_3 = 'value'; // Novo estado para ordenação do 1.3
        let currentYear = 2023;
        const tooltip = d3.select("#tooltip");

        let visibleKeys = {
            populacaoTotal: true,
            intensidadePobreza: true,
            pop65: true,
            riscoPobreza: true,
            desemprego: true
        };

        function updateMapYear(year) {
            currentYear = parseInt(year);
            d3.select("#yearDisplay").text(currentYear);
            drawMap(); 
        }

        function highlight(distritoId) {
            const targetClass = `.d-${distritoId}`;
            d3.selectAll("rect, circle, line, path, .map-circle").classed("dimmed", true);
            d3.selectAll(targetClass).classed("dimmed", false).classed("highlighted", true).classed("line-highlighted", true);
            const dist = distritos.find(d => d.id === distritoId);
            if(dist) {
                const dataAno = dist.historico[currentYear];
                d3.select("#map-narrative").html(`<strong>${dist.nome}</strong> (${currentYear})<br>Sem-Abrigo: ${dataAno.semabrigo} (Taxa: ${dataAno.taxa}/10k)<br>População: ${fnum(dataAno.populacao)}`);
            }
        }

        function unhighlight() {
            if (selectedDistrito !== null) return;
            d3.selectAll(".dimmed").classed("dimmed", false);
            d3.selectAll(".highlighted").classed("highlighted", false);
            d3.selectAll(".line-highlighted").classed("line-highlighted", false);
            d3.select("#map-narrative").html("<strong>Padrão Espacial:</strong> Passe o rato no mapa. O tamanho dos círculos representa a <strong>População</strong> e a cor a <strong>Taxa de Sem-Abrigo</strong> (Cinza/Azul = Baixo, Laranja = Alto).");
        }

        function toggleSelect(distritoId) {
            if (selectedDistrito === distritoId) {
                selectedDistrito = null;
                unhighlight();
            } else {
                selectedDistrito = distritoId;
                highlight(distritoId);
            }
        }

        function setMetric(metric) {
            currentMetric = metric;
            d3.selectAll(".metric-btn").classed("active", false);
            d3.selectAll(".metric-btn").filter((d, i, n) => n[i].innerText.toLowerCase().includes(metric === 'renda' ? 'arrendamento' : 'compra')).classed("active", true);
            updateDumbbell();
            updateScatter();
        }

        function setSort(sortType) {
            currentSort = sortType;
            d3.select("#btn-val").classed("active", sortType==='value');
            d3.select("#btn-abc").classed("active", sortType==='name');
            updateDumbbell();
        }

        // --- FUNÇÃO DE ORDENAÇÃO PARA GRAFICO 1.3 ---
        function setSortInequality(sortType) {
            currentSort1_3 = sortType;
            d3.select("#btn-ineq-val").classed("active", sortType==='value');
            d3.select("#btn-ineq-abc").classed("active", sortType==='name');
            updateViz1_3(); // Redesenha 1.3
        }

        function drawViz1_1() {
            // Ajustei as margens para acomodar o eixo X em baixo
            const margin = {top: 20, right: 30, bottom: 30, left: 80},
                  width  = 520 - margin.left - margin.right,
                  height = 280 - margin.top  - margin.bottom;

            d3.select('#viz1-1').selectAll('*').remove();
            const container = d3.select('#viz1-1');
            const svg = container.append('svg').attr('viewBox', `0 0 520 280`).append('g').attr('transform', `translate(${margin.left},${margin.top})`);

            const activeKeys = ['populacaoTotal', 'intensidadePobreza', 'pop65', 'riscoPobreza', 'desemprego'].filter(k => visibleKeys[k]);
            const colors = {populacaoTotal:'#94a3b8', intensidadePobreza:'#FF7F0E', pop65:'#6baed6', riscoPobreza:'#d62728', desemprego:'#1F77B4'};
            const labels = {populacaoTotal:'População Total', intensidadePobreza:'Pop. Intensidade Pobreza', pop65:'Pop. >65', riscoPobreza:'Risco Pobreza', desemprego:'Desemprego'};

            const x0 = d3.scaleBand().domain(data11.map(d => d.year)).range([0, width]).padding(0.2);
            const x1 = d3.scaleBand().domain(activeKeys).range([0, x0.bandwidth()]).padding(0.05);
            const y = d3.scaleLinear().domain([0, 12000000]).range([height, 0]);

            // --- EIXO X (ANOS) MOVIDO PARA BAIXO ---
            svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x0).tickSize(0)).select('.domain').remove();
            svg.selectAll('.tick text').style('font-size', '11px').style('font-weight', 'bold');

            svg.append('g').call(d3.axisLeft(y).tickValues([0, 4000000, 8000000, 12000000]).tickFormat(d => fnum(d/1000))).select('.domain').remove();
            svg.append('g').attr('class', 'grid-y').call(d3.axisLeft(y).tickValues([0, 4000000, 8000000, 12000000]).tickSize(-width).tickFormat('')).selectAll('line').attr('stroke', '#e5e7eb').attr('stroke-opacity', 0.6);
            svg.select('.grid-y').selectAll('path').remove();

            const yearGroups = svg.selectAll('.year-group').data(data11).enter().append('g').attr('class', 'year-group').attr('transform', d => `translate(${x0(d.year)},0)`);

            activeKeys.forEach(key => {
                yearGroups.append('rect').attr('class', `bar bar-${key}`).attr('x', x1(key)).attr('y', height).attr('width', x1.bandwidth()).attr('height', 0).attr('fill', colors[key]).style('opacity', 1)
                    .on('mouseover', function(e, d) {
                        d3.selectAll('.bar').style('opacity', 0.3);
                        d3.select(this).style('opacity', 1);
                        tooltip.style('opacity', 1).html(`<strong>${labels[key]}</strong><br>Ano: ${d.year}<br><strong>${fnum(d[key]/1000)} (milhares)</strong>`).style('left', e.pageX + 10 + 'px').style('top',  e.pageY - 20 + 'px');
                    })
                    .on('mouseout', () => { d3.selectAll('.bar').style('opacity', 1); tooltip.style('opacity', 0); })
                    .transition().duration(800).ease(d3.easeCubicOut)
                    .attr('y', d => y(d[key])).attr('height', d => height - y(d[key]));
            });
        }

        function drawViz1_2() {
            const margin = {top: 20, right: 10, bottom: 30, left: 50}, width = 400 - margin.left - margin.right, height = 200 - margin.top - margin.bottom;
            const svg = d3.select("#viz1-2").append("svg").attr("viewBox", `0 0 450 200`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            const x = d3.scaleBand().domain(data1_2.map(d => d.year)).range([0, width]).padding(0.3);
            const y1 = d3.scaleLinear().domain([200000, 270000]).range([height, 0]); 
            const y2 = d3.scaleLinear().domain([0, 30000]).range([height, 0]); 
            const y3 = d3.scaleLinear().domain([-1, 10]).range([height, 0]); 

            svg.selectAll(".bar-inflacao").data(data1_2).enter().append("rect").attr("x", d => x(d.year)).attr("width", x.bandwidth()).attr("y", d => y3(Math.max(0, d.inflacao))).attr("height", d => Math.abs(y3(d.inflacao) - y3(0))).attr("fill", "#ccc").attr("opacity", 0.5)
                .on("mouseover", (e,d)=> tooltip.style("opacity",1).html(`Inflação: ${d.inflacao}%`).style("left", (e.pageX)+"px").style("top", (e.pageY)+"px")).on("mouseout", ()=>tooltip.style("opacity",0));

            svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x).tickFormat(d3.format("d"))).select(".domain").remove();
            svg.append("g").call(d3.axisLeft(y1).ticks(4).tickFormat(d => d/1000 + "k")).select(".domain").remove().selectAll("text").attr("fill", "#1F77B4");
            svg.append("g").attr("transform", `translate(${width},0)`).call(d3.axisRight(y2).ticks(4)).select(".domain").remove().selectAll("text").attr("fill", "#FF7F0E");

            const line1 = d3.line().x(d => x(d.year) + x.bandwidth()/2).y(d => y1(d.poder));
            svg.append("path").datum(data1_2).attr("fill", "none").attr("stroke", "#1F77B4").attr("stroke-width", 2).attr("d", line1);
            const line2 = d3.line().x(d => x(d.year) + x.bandwidth()/2).y(d => y2(d.semabrigo));
            svg.append("path").datum(data1_2).attr("fill", "none").attr("stroke", "#FF7F0E").attr("stroke-width", 2).attr("d", line2);
            svg.selectAll("circle.eco").data(data1_2).enter().append("circle").attr("cx", d=>x(d.year)+x.bandwidth()/2).attr("cy", d=>y1(d.poder)).attr("r", 3).attr("fill", "#1F77B4").on("mouseover", (e,d)=> tooltip.style("opacity",1).html(`Poder: ${fnum(d.poder)}M€`).style("left", (e.pageX)+"px").style("top", (e.pageY)+"px")).on("mouseout", ()=>tooltip.style("opacity",0));
            svg.selectAll("circle.homeless").data(data1_2).enter().append("circle").attr("cx", d=>x(d.year)+x.bandwidth()/2).attr("cy", d=>y2(d.semabrigo)).attr("r", 3).attr("fill", "#FF7F0E").on("mouseover", (e,d)=> tooltip.style("opacity",1).html(`Sem-Abrigo: ${fnum(d.semabrigo)}`).style("left", (e.pageX)+"px").style("top", (e.pageY)+"px")).on("mouseout", ()=>tooltip.style("opacity",0));
        }

        // --- GRAFICO 1.3 ATUALIZADO (EIXO X + TOOLTIP + ORDENAÇÃO) ---
        function updateViz1_3() {
            const container = d3.select("#viz1-3");
            container.selectAll("*").remove(); // Limpar conteúdo anterior

            // Lógica de Ordenação
            const sortedData = [...inequalityData].sort((a,b) => {
                if (currentSort1_3 === 'name') return a.distrito.localeCompare(b.distrito);
                // Ordenar por valor (descendente pelo valor de 2023)
                return b.values[5].value - a.values[5].value;
            });

            const w = 200, h = 110; // Aumentei um pouco a altura para caber o eixo X
            
            sortedData.forEach(d => {
                const div = container.append("div").style("text-align", "center");
                const distInfo = distritos.find(x => x.nome === d.distrito);
                const id = distInfo ? distInfo.id : "unknown";
                
                div.append("div").text(d.distrito)
                    .style("font-size", "10px")
                    .style("font-weight", "bold")
                    .style("color", d.distrito==="Beja"?"#FF7F0E":(d.distrito==="Lisboa"||d.distrito==="Porto"?"#1F77B4":"#666"));
                
                const svg = div.append("svg").attr("viewBox", `0 0 ${w} ${h}`).style("width", "100%").style("height", "auto");
                const margin = {left: 25, right: 15, top: 10, bottom: 20}; // Margem inferior maior
                
                const x = d3.scaleLinear().domain([2018, 2023]).range([margin.left, w-margin.right]);
                const y = d3.scaleLinear().domain([6, 14]).range([h-margin.bottom, margin.top]);
                const line = d3.line().x(v => x(v.year)).y(v => y(v.value));

                // Eixo Y
                svg.append("g").attr("transform", `translate(${margin.left},0)`)
                    .call(d3.axisLeft(y).ticks(4).tickSize(3).tickFormat(d3.format(".0f")))
                    .style("font-size", "8px").style("color", "#666");
                
                // Eixo X (Anos) - NOVO - FORÇAR TODOS OS ANOS
                svg.append("g").attr("transform", `translate(0,${h-margin.bottom})`)
                    .call(d3.axisBottom(x)
                        .tickValues([2018, 2019, 2020, 2021, 2022, 2023]) // Mostrar todos
                        .tickFormat(d => `'${String(d).slice(2)}`) // Formatar como '18, '19... para caber
                    )
                    .style("font-size", "8px").style("color", "#999")
                    .select(".domain").remove();

                // Linha do gráfico
                svg.append("path").datum(d.values).attr("d", line)
                    .attr("fill", "none")
                    .attr("stroke", d.distrito==="Beja" ? "#FF7F0E" : (d.distrito==="Lisboa"||d.distrito==="Porto" ? "#1F77B4" : "#ccc"))
                    .attr("stroke-width", 2).attr("class", `d-${id}`)
                    .style("cursor", "pointer")
                    .on("mouseover", () => { if (selectedDistrito === null) highlight(id); })
                    .on("mouseout", () => { unhighlight(); })
                    .on("click", (event) => { event.stopPropagation(); toggleSelect(id); });

                // PONTOS INVISÍVEIS PARA INTERAÇÃO (TOOLTIP) - NOVO
                // Cria um ponto para cada ano sobre a linha para detetar o rato
                svg.selectAll("circle.overlay").data(d.values).enter().append("circle")
                    .attr("cx", v => x(v.year))
                    .attr("cy", v => y(v.value))
                    .attr("r", 5) // Área de "hit" confortável
                    .attr("fill", "transparent") 
                    .style("cursor", "crosshair")
                    .on("mouseover", (e, val) => {
                        tooltip.style("opacity", 1)
                            .html(`<strong>${d.distrito} (${val.year})</strong><br>Desigualdade S80/S20: ${val.value}`)
                            .style("left", (e.pageX) + "px")
                            .style("top", (e.pageY - 20) + "px");
                        
                        // Feedback visual: desenha um ponto visivel temporário
                        d3.select(e.target).attr("fill", "#1F77B4").attr("r", 3).attr("stroke", "white");
                    })
                    .on("mouseout", (e) => {
                        tooltip.style("opacity", 0);
                        d3.select(e.target).attr("fill", "transparent").attr("r", 5).attr("stroke", "none");
                    });

                // Valor final à direita (legenda estática)
                svg.append("text")
               .attr("x", w - 5) // Mova para a direita se tiver espaço, ou mantenha w-12
               .attr("y", y(d.values[5].value))
               .text(d.values[5].value)
               .style("font-size", "9px")
               .attr("fill", "#666")
               .attr("text-anchor", "end"); // Importante: Alinhar à direita para não sair da margem
            });
        }

        let dumbbellSvg, yDumbbell;
        function drawViz2_1() {
            const margin = {top: 25, right: 20, bottom: 20, left: 100}, width = 200 - margin.left - margin.right, height = 400 - margin.top - margin.bottom;
            dumbbellSvg = d3.select("#viz2-1").append("svg").attr("viewBox", `0 0 600 400`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            yDumbbell = d3.scaleBand().range([0, height]).padding(1);
            dumbbellSvg.append("g").attr("class", "x-axis").attr("transform", "translate(0,-10)");
            dumbbellSvg.append("g").attr("class", "y-axis");
            updateDumbbell();
        }

        function updateDumbbell() {
            const k18 = currentMetric === 'renda' ? 'renda18' : 'compra18';
            const k23 = currentMetric === 'renda' ? 'renda23' : 'compra23';
            
            const textoRenda = "Destaque para Lisboa, Setúbal e Porto.";
            const textoCompra = "Valores de Compra muito dispersos. Fosso Litoral vs Interior agrava-se.";
            d3.select("#dumbbell-narrative").html(currentMetric === 'renda' ? textoRenda : textoCompra);

            const minVal = currentMetric === 'renda' ? 2 : 500;
            const maxVal = currentMetric === 'renda' ? 12 : 4000;

            const sorted = [...distritos].sort((a,b) => currentSort === 'value' ? (b[k23] - b[k18]) - (a[k23] - a[k18]) : a.nome.localeCompare(b.nome));
            
            const x = d3.scaleLinear().domain([minVal, maxVal]).range([0, 480]);
            yDumbbell.domain(sorted.map(d => d.nome));
            
            dumbbellSvg.select(".x-axis").transition().duration(1000).call(d3.axisTop(x).ticks(5).tickFormat(fnum)).select(".domain").remove();
            dumbbellSvg.select(".y-axis").transition().duration(1000).call(d3.axisLeft(yDumbbell).tickSize(0)).select(".domain").remove();
            
            const lines = dumbbellSvg.selectAll("line.connector").data(sorted, d => d.id);
            lines.enter().append("line").attr("class", d => `connector d-${d.id}`).attr("stroke", "#cbd5e1").attr("stroke-width", 3).merge(lines).transition().duration(1000).attr("x1", d => x(d[k18])).attr("x2", d => x(d[k23])).attr("y1", d => yDumbbell(d.nome)).attr("y2", d => yDumbbell(d.nome));
            
            const drawDots = (cls, key, col) => {
                const dots = dumbbellSvg.selectAll(`circle.${cls}`).data(sorted, d => d.id);
                const dotsEnter = dots.enter().append("circle").attr("class", d => `${cls} d-${d.id}`).attr("r", 5).style("cursor", "pointer").on("click", (e, d) => { e.stopPropagation(); toggleSelect(d.id); });

                dotsEnter.merge(dots).attr("fill", col)
                    .on("mouseover", (e, d) => {
                        if (selectedDistrito === null) highlight(d.id);
                        const isRenda = currentMetric === 'renda';
                        const v18 = isRenda ? d.renda18 : d.compra18;
                        const v23 = isRenda ? d.renda23 : d.compra23;
                        const labelTipo = currentMetric === 'renda' ? "Renda" : "Preço Venda";
                        tooltip.style("opacity", 1).html(`<strong>${d.nome}</strong><br>${labelTipo} (2018): ${fnum(v18)}€<br>${labelTipo} (2023): ${fnum(v23)}€`).style("left", (e.pageX) + "px").style("top", (e.pageY) + "px");
                    })
                    .on("mouseout", () => { unhighlight(); tooltip.style("opacity", 0); })
                    .transition().duration(1000).attr("cx", d => x(d[key])).attr("cy", d => yDumbbell(d.nome));
                dots.exit().remove();
            };
            drawDots("dot18", k18, "#94a3b8");
            drawDots("dot23", k23, "#1F77B4");
        }

        // --- MAPA DINÂMICO ---
        function drawMap() {
            const width = 300, height = 350;
            d3.select("#viz-map").selectAll("*").remove(); 
            const svg = d3.select("#viz-map").append("svg").attr("width", width).attr("height", height);
            
            const grid = [
                {id: "vianadocastelo", x: 0, y: 0}, {id: "braga", x: 1, y: 0}, {id: "vilareal", x: 2, y: 0}, {id: "braganca", x: 3, y: 0},
                {id: "porto", x: 0, y: 1}, {id: "viseu", x: 1, y: 1}, {id: "guarda", x: 2, y: 1},
                {id: "aveiro", x: 0, y: 2}, {id: "coimbra", x: 1, y: 2}, {id: "castelobranco", x: 2, y: 2},
                {id: "leiria", x: 0, y: 3}, {id: "santarem", x: 1, y: 3}, {id: "portalegre", x: 2, y: 3},
                {id: "lisboa", x: 0, y: 4}, {id: "evora", x: 1, y: 4},
                {id: "setubal", x: 0, y: 5}, {id: "beja", x: 1, y: 5},
                {id: "faro", x: 1, y: 6}
            ];
            
            const colorScale = d3.scaleThreshold().domain([2, 5, 10]).range(["#cbd5e1", "#9ecae1", "#3182bd", "#FF7F0E"]); 
            const sizeScale = d3.scaleSqrt().domain([0, 2500000]).range([30, 70]);

            svg.selectAll("circle").data(grid).enter().append("circle").attr("class", d => `map-circle d-${d.id}`)
                .attr("r", d => {
                    const dist = distritos.find(x => x.id === d.id);
                    const pop = dist.historico[currentYear].populacao;
                    return sizeScale(pop) / 2; 
                })
                .attr("cx", d => (d.x * 50 + 50) + 25)
                .attr("cy", d => (d.y * 45 + 20) + 22.5)
                .attr("fill", d => { 
                    const dist = distritos.find(x => x.id === d.id); 
                    const taxa = dist.historico[currentYear].taxa;
                    return colorScale(taxa); 
                })
                .on("mouseover", (e, d) => { if (selectedDistrito === null) highlight(d.id); })
                .on("mouseout", unhighlight).on("click", (e, d) => { toggleSelect(d.id); });

            svg.selectAll("text").data(grid).enter().append("text").attr("class", "map-label")
                .attr("x", d => (d.x * 50 + 50) + 25)
                .attr("y", d => (d.y * 45 + 20) + 22.5 + 4)
                .text(d => d.id.substring(0,3).toUpperCase()).attr("text-anchor", "middle");
        }

        let scatterSvg, scatterX;
        function drawScatter() {
            const margin = {top: 20, right: 30, bottom: 40, left: 50}, width = 1200 - margin.left - margin.right, height = 300 - margin.top - margin.bottom;
            scatterSvg = d3.select("#viz-scatter").append("svg").attr("viewBox", `0 0 1200 300`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            scatterX = d3.scaleLinear().domain([0, 15]).range([0, width]);
            const y = d3.scaleLinear().domain([0, 45]).range([height, 0]); 
            scatterSvg.append("g").attr("class", "x-axis").attr("transform", `translate(0,${height})`).call(d3.axisBottom(scatterX));
            scatterSvg.append("g").call(d3.axisLeft(y));
            scatterSvg.append("text").attr("class", "x-label").attr("x", width/2).attr("y", height+35).text("Preço Habitação");
            scatterSvg.append("text").attr("transform", "rotate(-90)").attr("y", -35).attr("x", -height/2).text("Taxa Sem-Abrigo (por 10k)");
            scatterSvg.selectAll("circle").data(distritos).enter().append("circle").attr("class", d => `d-${d.id}`).attr("cx", d => scatterX(d.renda23)).attr("cy", d => y(d.semabrigo)).attr("r", d => Math.sqrt(d.populacao)/50).attr("fill", d => d.regiao === "Alentejo" ? "#FF7F0E" : "#1F77B4").attr("opacity", 0.7).attr("stroke", "white")
                .on("mouseover", (e, d) => { 
                    if (selectedDistrito === null) highlight(d.id); 
                    const val = currentMetric === 'renda' ? d.renda23 : d.compra23;
                    const labelTipo = currentMetric === 'renda' ? "Renda" : "Preço Venda";
                    tooltip.style("opacity", 1).html(`<strong>${d.nome}</strong><br>Sem-Abrigo: ${d.semabrigo} (Taxa)<br>${labelTipo}: ${fnum(val)}€<br>População: ${fnum(d.populacao)}`).style("left", (e.pageX+10)+"px").style("top", (e.pageY-20)+"px"); 
                })
                .on("mouseout", () => { unhighlight(); tooltip.style("opacity", 0); }).on("click", (e, d) => { toggleSelect(d.id); });
        }

        function updateScatter() {
            const k = currentMetric === 'renda' ? 'renda23' : 'compra23';
            const minVal = currentMetric === 'renda' ? 2 : 500; 
            const maxVal = currentMetric === 'renda' ? 12 : 4000;
            scatterX.domain([minVal, maxVal]);
            scatterSvg.select(".x-axis").transition().duration(1000).call(d3.axisBottom(scatterX).tickFormat(fnum));
            scatterSvg.select(".x-label").text(currentMetric === 'renda' ? "Renda Média (€/m²)" : "Preço Compra (€/m²)");
            scatterSvg.selectAll("circle").transition().duration(1000).attr("cx", d => scatterX(d[k]));
        }

        // CHAMADA INICIAL UNIFICADA
        drawViz1_1(); 
        drawViz1_2(); 
        updateViz1_3(); // Nome correto da função que desenha o 1.3
        drawViz2_1(); 
        drawMap(); 
        drawScatter();

    </script>
</body>
</html>